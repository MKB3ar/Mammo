<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Mammography AI – Radiology Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script> 
    <style>
        body {
            background: linear-gradient(135deg, #f0f9ff, #f6fefb);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.4s ease-out forwards;
        }

        .glass-effect {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.7);
        }

        img.dicom-preview {
            max-width: 100%;
            height: auto;
            object-fit: contain;
        }
    </style>
</head>
<body class="min-h-screen bg-blue-50 relative">

<!-- Основной контент -->
<div class="max-w-5xl w-full mx-auto px-4 py-10 glass-effect rounded-xl shadow-md border border-gray-200">

    <!-- Заголовок -->
    <div class="bg-gradient-to-r from-blue-600 to-teal-500 text-white py-6 px-6 rounded-t-xl">
        <h1 class="text-2xl font-bold">AI Mammography Assistant</h1>
        <p class="text-sm text-blue-100">Искусственный интеллект для маммографического анализа</p>
    </div>

    <!-- Две колонки: изображение + теги DICOM -->
    <div class="flex flex-col md:flex-row gap-6 p-6">
        <!-- Левая колонка: изображение -->
        <div class="w-full md:w-1/2 space-y-4">
            <label class="block text-sm font-medium text-gray-700">Загрузите DICOM-файл:</label>
            <form id="upload-form" class="space-y-4">
                <input type="file" name="file" accept=".dcm"
                       class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4
                              file:rounded-md file:border-0 file:text-sm file:font-semibold
                              file:bg-gradient-to-r from-blue-500 to-indigo-600 file:text-white
                              hover:file:bg-gradient-to-r hover:file:from-blue-600 hover:file:to-indigo-700 cursor-pointer">
                <button type="submit"
                        class="w-full py-2.5 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-md shadow hover:shadow-lg transition duration-200 font-medium">
                    Анализировать
                </button>
            </form>

            <!-- Превью DICOM -->
            <div class="mt-4">
                <img id="dicom-preview" src="" alt="DICOM Preview"
                     class="dicom-preview w-full h-auto rounded border border-gray-200 shadow-md hidden" />
            </div>

            <!-- Тепловая карта -->
            <div id="heatmap-container" class="mt-4 hidden">
                <h3 class="text-sm font-semibold text-gray-700 mb-2">Тепловая карта поражения</h3>
                <img id="heatmap" src="" alt="Heatmap" class="w-full h-auto rounded border border-gray-200 shadow-md" />
            </div>

            <!-- Кнопки действий -->
            <div id="kafka-button" class="hidden mt-6">
                <button onclick="sendToKafka()"
                        class="w-full py-2.5 bg-gradient-to-r from-purple-600 to-indigo-700 text-white rounded-md shadow hover:shadow-lg transition duration-200 font-medium">
                    Отправить в Kafka
                </button>
            </div>

            <div id="report-button" class="hidden mt-2">
                <button onclick="generateReport()"
                        class="w-full py-2.5 bg-gradient-to-r from-orange-500 to-amber-600 text-white rounded-md shadow hover:shadow-lg transition duration-200 font-medium">
                    Сформировать отчет в формате DICOM SR
                </button>
            </div>

            <div class="text-center mt-6">
                <button onclick="openFAQ()" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700 transition">
                    Как работать с сервисом?
                </button>
            </div>
        </div>

        <!-- Правая колонка: информация и результаты -->
        <div class="w-full md:w-1/2 space-y-4">
            <!-- Таблица тегов -->
            <div id="tag-table" class="mt-4">
                <h3 class="text-sm font-semibold text-gray-700 mb-2">Основные DICOM Теги</h3>
                <table class="w-full table-auto text-sm border-collapse">
                    <tbody id="tag-body" class="divide-y divide-gray-200">
                        <tr><td colspan="2" class="italic text-gray-400 text-center py-2">Нет данных</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- Предупреждения -->
            <div id="warnings" class="hidden mt-4 p-4 bg-yellow-50 rounded-md border border-yellow-200">
                <h2 class="text-sm font-semibold text-yellow-800 mb-2">Предупреждения по тегам</h2>
                <ul id="warnings-list" class="list-disc pl-5 text-sm text-yellow-700 space-y-1"></ul>
                <button onclick="continueAnalysis()"
                        class="mt-3 px-4 py-1.5 bg-green-500 text-white text-sm rounded hover:bg-green-600 transition">
                    Продолжить анализ
                </button>
            </div>

            <!-- Результаты модели -->
            <div id="result" class="hidden mt-4 space-y-3">
                <div id="diagnosis" class="text-lg font-semibold text-gray-800 fade-in"></div>
                <div id="class-info" class="text-green-700 font-medium fade-in"></div>
                <div id="birads-info" class="text-blue-700 font-medium fade-in"></div>
                <div id="area-info" class="text-sm text-gray-600 fade-in"></div>
            </div>
        </div>
    </div>

    <!-- Подвал -->
    <div class="text-center text-xs text-gray-400 pb-6 z-10 relative">
        © Маммографический ИИ-Ассистент | v1.0 · For research use only
    </div>
</div>

    <!-- Модальное окно FAQ -->
<div id="faq-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white w-full max-w-3xl rounded-xl shadow-lg overflow-hidden">
        <div class="p-4 bg-blue-600 text-white">
            <h2 class="text-xl font-bold">Как работать с сервисом?</h2>
        </div>
        <div class="p-6 space-y-4 text-sm text-gray-800">
            <p><strong>1. Загрузите DICOM-файл</strong>:<br>
               Нажмите на кнопку "Загрузить файл" и выберите изображение формата .dcm.</p>
            <p><strong>2. Анализировать</strong>:<br>
               После загрузки нажмите «Анализировать».</p>
            <p><strong>3. Предупреждения по тегам</strong>:<br>
               Если DICOM содержит ошибки/некорректные теги — они будут выделены. Нажмите «Продолжить анализ».</p>
            <p><strong>4. Результат анализа</strong>:<br>
               Появится тепловая карта поражения, BI-RADS категория, тип образования и площадь.</p>
            <p><strong>5. Отправка в Kafka</strong>:<br>
               Кнопка «Отправить в Kafka» отправляет результат в систему в формате JSON.</p>
            <p><strong>6. Сформировать отчет</strong>:<br>
               Кнопка «Сформировать отчет» создаёт структурированный отчёт в формате SR (Structured Report).</p>
            <p><strong>Интерпретация результатов</strong>:<br>
               - <span class="font-medium">Подозрение на патологию</span>: модель обнаружила область, требующую внимания.<br>
               - <span class="font-medium">BI-RADS</span>: категория злокачественности по шкале от 1 до 6.<br>
               - <span class="font-medium">Тип образования</span>: CALC — микрокальцинаты, CIRC — округлое, MISC — другое.<br>
               - <span class="font-medium">Вероятность</span>: чем выше процент — тем больше уверенность модели.</p>
            <p><strong>Рекомендации</strong>:<br>
               Все результаты являются предварительными. Для точного диагноза необходима консоль маммолога.</p>
            <p><strong>Технические требования к файлам</strong>:<br>
               Формат: только .dcm<br>
               Modality: MG (Mammography)<br>
               Размер: 512×512<br>
               Глубина: 8 бит</p>
        </div>
        <div class="p-4 border-t flex justify-end">
            <button onclick="closeFAQ()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                Ознакомлен
            </button>
        </div>
    </div>
</div>

<!-- Модальное окно отчёта -->
<div id="report-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white w-full max-w-3xl rounded-xl shadow-lg overflow-hidden">
        <div class="p-4 bg-gray-800 text-white">
            <h2 class="text-xl font-bold">DICOM SR Report</h2>
        </div>
        <div class="p-4 space-y-4" id="report-content">
            <p>Нет данных. Выполни анализ и нажми "Сформировать отчет"</p>
        </div>
        <div class="p-4 border-t flex justify-end gap-2">
            <button onclick="downloadReport()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                Скачать JSON
            </button>
            <button onclick="closeReport()" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">
                Закрыть
            </button>
        </div>
    </div>
</div>

<script>
    const form = document.getElementById("upload-form");
    const dicomPreview = document.getElementById("dicom-preview");

    const tagBody = document.getElementById("tag-body");
    const warningsDiv = document.getElementById("warnings");
    const warningsList = document.getElementById("warnings-list");
    const resultDiv = document.getElementById("result");

    const diagnosis = document.getElementById("diagnosis");
    const classInfo = document.getElementById("class-info");
    const biradsInfo = document.getElementById("birads-info");
    const areaInfo = document.getElementById("area-info");

    const heatmapContainer = document.getElementById("heatmap-container");
    const reportButton = document.getElementById("report-button");
    const kafkaButton = document.getElementById("kafka-button")

    let analysis_result = null;

    // --- Обновление таблицы тегов ---
    function updateDicomTags(tags) {
        tagBody.innerHTML = "";
        if (Object.keys(tags).length === 0) {
            const tr = document.createElement("tr");
            const td = document.createElement("td");
            td.setAttribute("colspan", "2");
            td.className = "italic text-gray-400 text-center py-2";
            td.textContent = "Нет данных";
            tr.appendChild(td);
            tagBody.appendChild(tr);
            return;
        }

        Object.entries(tags).forEach(([name, value]) => {
            const tr = document.createElement("tr");
            tr.className = "border-b border-gray-200";

            const tdName = document.createElement("td");
            tdName.className = "py-1 px-2 font-medium text-gray-800";
            tdName.textContent = name;

            const tdValue = document.createElement("td");
            tdValue.className = "py-1 px-2 text-gray-600 truncate max-w-xs";
            tdValue.textContent = value || "(empty)";
            tdValue.title = value || "(empty)";

            tr.appendChild(tdName);
            tr.appendChild(tdValue);
            tagBody.appendChild(tr);
        });
    }

    // --- Загрузка файла ---
    form.addEventListener("submit", async function (e) {
        e.preventDefault();
        const formData = new FormData(form);

        const response = await fetch("/upload", {
            method: "POST",
            body: formData
        });

        const data = await response.json();

        if (data.error) {
            alert(data.error);
            return;
        }

        // --- Превью изображения ---
        if (data.preview_url) {
            dicomPreview.src = data.preview_url;
            dicomPreview.classList.remove("hidden");
        } else {
            dicomPreview.classList.add("hidden");
        }

        // --- Теги ---
        updateDicomTags(data.extracted_tags || {});

        // --- Предупреждения ---
        warningsList.innerHTML = "";
        if (data.warnings.length > 0) {
            data.warnings.forEach(w => {
                const li = document.createElement("li");
                li.textContent = w;
                warningsList.appendChild(li);
            });
            warningsDiv.classList.remove("hidden");
        } else {
            warningsDiv.classList.add("hidden");
            continueAnalysis();  // Автоматически продолжаем, если нет ошибок
        }

        resultDiv.classList.add("hidden");
        heatmapContainer.classList.add("hidden");
        reportButton.classList.add("hidden");
    });

    // --- Продолжить анализ ---
    async function continueAnalysis() {
        const response = await fetch("/analyze", { method: "POST" });
        const data = await response.json();

        if (data.error) {
            alert(data.error);
            return;
        }

        analysis_result = data;

        warningsDiv.classList.add("hidden");
        resultDiv.classList.remove("hidden");
        heatmapContainer.classList.remove("hidden");

        diagnosis.textContent = data.pathology_flag ?
            "Подозрение на патологию" :
            "Норма";

        classInfo.textContent = `Тип образования: ${data.predicted_class} (${data.class_confidence}% уверенности)`;
        biradsInfo.textContent = `BI-RADS: ${data.predicted_birads} (${data.birads_confidence}% уверенности)`;

        let areaText = `Площадь: ${data.lesion_area_px} px`;
        if (data.lesion_area_mm2 !== undefined && data.lesion_area_mm2 !== null) {
            areaText += ` (~${data.lesion_area_mm2} мм²)`;
        }
        areaInfo.textContent = areaText;

        // Показываем время обработки
        let timeInfo = document.getElementById("time-info");
        if (!timeInfo) {
            timeInfo = document.createElement("div");
            timeInfo.id = "time-info";
            timeInfo.className = "text-sm text-gray-600 fade-in";
            resultDiv.appendChild(timeInfo);
        }
        timeInfo.textContent = `Время обработки моделью: ${data.processing_time_sec} сек.`;

        heatmap.src = data.image_url;

        document.getElementById("kafka-button").classList.remove("hidden");
        document.getElementById("report-button").classList.remove("hidden");
    }

    // --- Отправка в Kafka ---
    async function sendToKafka() {
        const response = await fetch("/send_to_kafka", { method: "POST" });
        const data = await response.json();

        if (data.status === "success") {
            alert("✅ Результат отправлен в Kafka");
            console.log("Kafka message:", data.kafka_message);
        } else {
            alert("❌ Ошибка при отправке в Kafka: " + (data.error || "Неизвестная ошибка"));
        }
    }

    // --- Формирование отчёта ---
    let reportData = null;

    async function generateReport() {
        const response = await fetch("/generate_report", { method: "GET" });
        const data = await response.json();

        if (data.error) {
            alert("Ошибка: " + data.error);
            return;
        }

        reportData = data.report;

        const contentDiv = document.getElementById("report-content");
        contentDiv.innerHTML = `
            <table class="min-w-full divide-y divide-gray-200">
              <tbody class="divide-y divide-gray-100">
                <tr><td class="font-semibold py-2 px-2">Modality</td><td class="py-2 px-2">${reportData.Modality}</td></tr>
                <tr><td class="font-semibold py-2 px-2">Область исследования</td><td class="py-2 px-2">${reportData["Область исследования"]}</td></tr>
                <tr><td class="font-semibold py-2 px-2">Study Instance UID</td><td class="py-2 px-2">${reportData["Study Instance UID"]}</td></tr>
                <tr><td class="font-semibold py-2 px-2">Дата и время заключения</td><td class="py-2 px-2">${reportData["Дата и время заключения"]}</td></tr>
                <tr><td class="font-semibold py-2 px-2">Наименование сервиса</td><td class="py-2 px-2">${reportData["Наименование сервиса"]}</td></tr>
                <tr><td class="font-semibold py-2 px-2">Версия сервиса</td><td class="py-2 px-2">${reportData["Версия сервиса"]}</td></tr>
                <tr><td class="font-semibold py-2 px-2">Назначение сервиса</td><td class="py-2 px-2">${reportData["Назначение сервиса"]}</td></tr>
                <tr><td class="font-semibold py-2 px-2">Технические данные</td><td class="py-2 px-2">${reportData["Технические данные"]}</td></tr>
                <tr><td class="font-semibold py-2 px-2">Описание</td><td class="py-2 px-2">${reportData.Описание}</td></tr>
                <tr><td class="font-semibold py-2 px-2">Заключение</td><td class="py-2 px-2">${reportData.Заключение}</td></tr>
                <tr><td class="font-semibold py-2 px-2">Тип патологии</td><td class="py-2 px-2">${reportData["Тип патологии"]}</td></tr>
                <tr><td class="font-semibold py-2 px-2">Вероятность патологии</td><td class="py-2 px-2">${reportData["Вероятность патологии"]}</td></tr>
                <tr><td class="font-semibold py-2 px-2">Рекомендации</td><td class="py-2 px-2">${reportData.Рекомендации}</td></tr>
                <tr><td class="font-semibold py-2 px-2">ПРЕДУПРЕЖДЕНИЕ</td><td class="italic py-2 px-2 text-red-600">${reportData["Предупреждение (1)"]}</td><td></td></tr>
                <tr><td class="font-semibold py-2 px-2">ПРЕДУПРЕЖДЕНИЕ</td><td class="italic py-2 px-2 text-red-600">${reportData["Предупреждение (2)"]}</td><td></td></tr>
              </tbody>
            </table>
        `;

        document.getElementById("report-modal").classList.remove("hidden");
    }

    // --- Скачивание отчёта ---
    function downloadReport() {
        const blob = new Blob([JSON.stringify(reportData, null, 2)], {
            type: 'application/json'
        });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = "mammo_ai_sr_report.json";
        link.click();
    }

    // --- Закрытие модального окна ---
    function closeReport() {
        document.getElementById("report-modal").classList.add("hidden");
    }

    function openFAQ() {
        document.getElementById("faq-modal").classList.remove("hidden");
    }

    function closeFAQ() {
        document.getElementById("faq-modal").classList.add("hidden");
    }
</script>
</body>
</html>